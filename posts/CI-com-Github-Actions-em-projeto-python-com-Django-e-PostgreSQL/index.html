<!DOCTYPE html><html lang="pt-BR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="CI com Github Actions em projeto python com Django e PostgreSQL" /><meta property="og:locale" content="pt_BR" /><meta name="description" content="Tenho dedicado um tempo a me familiarizar com a forma de construir pipelines de integração contínua com o github actions e, depois de algumas tentativas de construir uma para um projeto Django + PostgreSQL, resolvi documentar." /><meta property="og:description" content="Tenho dedicado um tempo a me familiarizar com a forma de construir pipelines de integração contínua com o github actions e, depois de algumas tentativas de construir uma para um projeto Django + PostgreSQL, resolvi documentar." /><link rel="canonical" href="https://paulovitorweb.github.io/posts/CI-com-Github-Actions-em-projeto-python-com-Django-e-PostgreSQL/" /><meta property="og:url" content="https://paulovitorweb.github.io/posts/CI-com-Github-Actions-em-projeto-python-com-Django-e-PostgreSQL/" /><meta property="og:site_name" content="Paulo Freitas" /><meta property="og:image" content="https://paulovitorweb.github.io/assets/img/github-actions-thumbnail.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-07T00:00:00-03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://paulovitorweb.github.io/assets/img/github-actions-thumbnail.png" /><meta property="twitter:title" content="CI com Github Actions em projeto python com Django e PostgreSQL" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-07T00:00:00-03:00","datePublished":"2022-03-07T00:00:00-03:00","description":"Tenho dedicado um tempo a me familiarizar com a forma de construir pipelines de integração contínua com o github actions e, depois de algumas tentativas de construir uma para um projeto Django + PostgreSQL, resolvi documentar.","headline":"CI com Github Actions em projeto python com Django e PostgreSQL","image":"https://paulovitorweb.github.io/assets/img/github-actions-thumbnail.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://paulovitorweb.github.io/posts/CI-com-Github-Actions-em-projeto-python-com-Django-e-PostgreSQL/"},"url":"https://paulovitorweb.github.io/posts/CI-com-Github-Actions-em-projeto-python-com-Django-e-PostgreSQL/"}</script><title>CI com Github Actions em projeto python com Django e PostgreSQL | Paulo Freitas</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Paulo Freitas"><meta name="application-name" content="Paulo Freitas"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/34652880?v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Paulo Freitas</a></div><div class="site-subtitle font-italic">Python developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARQUIVOS</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>PROJETOS</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>SOBRE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/paulovitorweb" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/paulo-vitor/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['paulogeo5','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>CI com Github Actions em projeto python com Django e PostgreSQL</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>CI com Github Actions em projeto python com Django e PostgreSQL</h1><div class="post-meta text-muted"> <span> Postado em <em class="" data-ts="1646622000" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-03-07 </em> </span><div class="d-flex justify-content-between"> <span> Por <em> <a href="https://github.com/paulovitorweb">Paulo Freitas</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1295 palavras"> <em>7 min</em> de leitura</span></div></div></div><div class="post-content"><p>Tenho dedicado um tempo a me familiarizar com a forma de construir pipelines de integração contínua com o github actions e, depois de algumas tentativas de construir uma para um projeto Django + PostgreSQL, resolvi documentar.</p><h2 id="um-primeiro-arquivo-do-ci"><span class="mr-2">Um primeiro arquivo do CI</span><a href="#um-primeiro-arquivo-do-ci" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>O github não quer ver a gente fazendo esforço e trata logo de sugerir alguns modelos de CI muito úteis com base nos arquivos do projeto. Por exemplo, abaixo alguns modelos e o que escolhi pra configurar um primeiro workflow considerando apenas o django, com testes e linting.</p><p><img data-src="/assets/img/github-actions-ci-suggestion.png" alt="Github Actions sugere alguns modelos de CI para o seu projeto" data-proofer-ignore></p><p>Em relação ao modelo sugerido alterei apenas a última linha para adequar à estrutura de pastas do projeto e o array em python-version. O fluxo todo usa apenas a máquina principal, sem container de serviço, e ficou assim:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">Django CI</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">main</span> <span class="pi">]</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">main</span> <span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>

    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">max-parallel</span><span class="pi">:</span> <span class="m">4</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">python-version</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">3.7</span><span class="pi">]</span>

    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Python ${{ matrix.python-version }}</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-python@v2</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">python-version</span><span class="pi">:</span> <span class="s">${{ matrix.python-version }}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install Dependencies</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">python -m pip install --upgrade pip</span>
        <span class="s">pip install -r requirements.txt</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run Tests</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">python app/manage.py test app/ &amp;&amp; flake8 --config app/.flake8</span>
</pre></table></code></div></div><p>Uma breve explicação sobre cada parte que nem de longe substitui uma necessária lida na documentação que eu aconselho fortemente:</p><ul><li>Na seção <code class="language-plaintext highlighter-rouge">on</code> definimos os eventos que disparam o fluxo de trabalho, neste caso, em caso de <code class="language-plaintext highlighter-rouge">push</code> e <code class="language-plaintext highlighter-rouge">pull request</code> na branch <code class="language-plaintext highlighter-rouge">main</code>.<li>Na seção <code class="language-plaintext highlighter-rouge">strategy</code> podemos definir uma matriz para diferentes configurações dos jobs. Aqui podemos por exemplo definir diferentes sistemas operacionais, arquiteturas e versões do python para usar no setup, mas optei por usar apenas uma (porquê? senti que deveria poupar recursos do github rs, afinal nesse primeiro momento queria primeiro fazer funcionar). Definindo dois sistemas operacionais diferentes e 3 versões do python, por exemplo, teríamos uma matriz com 6 trabalhos. Como estou usando apenas uma versão do python, na prática estou criando uma matriz de apenas 1 trabalho e não precisaria usar o strategy, mas preferi deixar a estrutura pronta para caso sinta a necessidade.<li>As duas primeiras etapas do build são basicamente ações prontas (<code class="language-plaintext highlighter-rouge">actions/checkout@v2</code> e <code class="language-plaintext highlighter-rouge">actions/setup-python@v2</code>) que usamos no nosso job, assim apenas referenciamos e não precisamos nos preocupar com algumas etapas usuais do processo.</ul><p>Abaixo o resultado do job, executando etapa de teste unitário e linting com flake8.</p><p><img data-src="/assets/img/github-actions-first-django-ci.png" alt="Logs de um CI simples apenas com a máquina runner" width="500" data-proofer-ignore></p><p>Depois de atualizar o banco de dados do projeto para o PostgreSQL, precisei pesquisar como fazer isso no github actions.</p><h2 id="adicionando-um-container-de-serviço"><span class="mr-2">Adicionando um container de serviço</span><a href="#adicionando-um-container-de-serviço" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Com o SQLite, apenas a própria máquina principal com o projeto django é suficiente para rodar os testes. Adicionando um banco como PostgreSQL ou MySQL, precisamos criar um container de serviço, semelhante ao que é feito com o docker-compose.</p><h3 id="variáveis-de-ambiente"><span class="mr-2">Variáveis de ambiente</span><a href="#variáveis-de-ambiente" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Vamos usa um container e a máquina runner (a do projeto django) precisa saber como acessar o banco de dados no container; vamos fazer isso usando variáveis de ambiente. É possível definir variáveis de ambiente no contexto <code class="language-plaintext highlighter-rouge">env</code> que serão utilizados nos jobs em três níveis do fluxo (com base na própria <a href="https://docs.github.com/en/actions/learn-github-actions/environment-variables" target="_blank">documentação</a>):</p><ul><li>Todo fluxo de trabalho, usando <code class="language-plaintext highlighter-rouge">env</code> no nível superior do arquivo.<li>O conteúdo de um job em um fluxo de trabalho, usando <code class="language-plaintext highlighter-rouge">jobs.&lt;job_id&gt;.env</code>;<li>Uma etapa específica dentro de um job, usando <code class="language-plaintext highlighter-rouge">jobs.&lt;job_id&gt;.steps[*].env</code>.</ul><p>Isso é muito importante e ajuda especialmente nessas integrações. Então, defini variáveis de configuração do banco de dados no segundo nível, no escopo do único job do fluxo - elas portanto ficam disponíveis em todo o job, incluindo nas etapas finais em que são executadas as migrações e os testes. Como o nome das variáveis de ambiente utilizadas pela imagem do postgres são diferentes, referenciei com <code class="language-plaintext highlighter-rouge">${{ env.&lt;VAR&gt; }}</code>. Isso já resolve um eventual problema de credenciais inválidas.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre><td class="rouge-code"><pre><span class="na">name</span><span class="pi">:</span> <span class="s">Django CI</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">main</span> <span class="pi">]</span>
  <span class="na">pull_request</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">main</span> <span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>

    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="na">DB_HOST</span><span class="pi">:</span> <span class="s">localhost</span>
      <span class="na">DB_NAME</span><span class="pi">:</span> <span class="s">postgres</span>
      <span class="na">DB_USER</span><span class="pi">:</span> <span class="s">postgres</span>
      <span class="na">DB_PASSWORD</span><span class="pi">:</span> <span class="s">supersecretpassword</span>

    <span class="na">services</span><span class="pi">:</span>
      <span class="na">postgres</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:10-alpine</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">POSTGRES_DB</span><span class="pi">:</span> <span class="s">${{ env.DB_NAME }}</span>
          <span class="na">POSTGRES_USER</span><span class="pi">:</span> <span class="s">${{ env.DB_USER }}</span>
          <span class="na">POSTGRES_PASSWORD</span><span class="pi">:</span> <span class="s">${{ env.DB_PASSWORD }}</span>
        <span class="c1"># Set health checks to wait until postgres has started</span>
        <span class="na">options</span><span class="pi">:</span> <span class="pi">&gt;-</span>
          <span class="s">--health-cmd pg_isready</span>
          <span class="s">--health-interval 10s</span>
          <span class="s">--health-timeout 5s</span>
          <span class="s">--health-retries 5</span>
        <span class="na">ports</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">5432:5432</span>

    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">max-parallel</span><span class="pi">:</span> <span class="m">4</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">python-version</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">3.7</span><span class="pi">]</span>

    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Python ${{ matrix.python-version }}</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-python@v2</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">python-version</span><span class="pi">:</span> <span class="s">${{ matrix.python-version }}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install postgres prerequisites</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">sudo apt-get install libpq-dev</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install Dependencies</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">python -m pip install --upgrade pip</span>
        <span class="s">pip install -r requirements.txt</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run migrations</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">python app/manage.py wait_for_db &amp;&amp; python app/manage.py migrate</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run Tests</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">flake8 --config app/.flake8 &amp;&amp; python app/manage.py test app/</span>
</pre></table></code></div></div><p>Há muito mais sobre variáveis de ambiente no github actions que você pode querer saber e a <a href="https://docs.github.com/en/actions/learn-github-actions/environment-variables" target="_blank">documentação</a> é excelente.</p><p>Abaixo uma explicação mais pormenorizada sobre o container de serviço e as modificações na máquina runner.</p><h3 id="container-de-serviço"><span class="mr-2">Container de serviço</span><a href="#container-de-serviço" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Citando a <a href="https://docs.github.com/en/actions/using-containerized-services/about-service-containers">documentação</a>:</p><blockquote><p>Os containers de serviço são containers do Docker que fornecem uma maneira simples e portátil de hospedar serviços que você pode precisar para testar ou operar seu aplicativo em um fluxo de trabalho. Por exemplo, seu fluxo de trabalho pode precisar executar testes de integração que exijam acesso a um banco de dados e cache de memória.</p></blockquote><p>No meu caso, tinha uma máquina runner com o projeto django e precisava de apenas um container de serviço para o PostgreSQL. A documentação é vasta e inclui um <a href="https://docs.github.com/en/actions/using-containerized-services/creating-postgresql-service-containers" target="_blank">excelente guia</a> para nos ajudar no processo. Minha imagem ficou configurada assim:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c1"># jobs.build</span>
    <span class="na">services</span><span class="pi">:</span>
      <span class="na">postgres</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:10-alpine</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">POSTGRES_DB</span><span class="pi">:</span> <span class="s">${{ env.DB_NAME }}</span>
          <span class="na">POSTGRES_USER</span><span class="pi">:</span> <span class="s">${{ env.DB_USER }}</span>
          <span class="na">POSTGRES_PASSWORD</span><span class="pi">:</span> <span class="s">${{ env.DB_PASSWORD }}</span>
        <span class="c1"># Set health checks to wait until postgres has started</span>
        <span class="na">options</span><span class="pi">:</span> <span class="pi">&gt;-</span>
          <span class="s">--health-cmd pg_isready</span>
          <span class="s">--health-interval 10s</span>
          <span class="s">--health-timeout 5s</span>
          <span class="s">--health-retries 5</span>
        <span class="na">ports</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">5432:5432</span>
</pre></table></code></div></div><p>As variáveis de ambiente definidas para o job foram acessadas e seus valores foram usados para definição das variáveis de ambiente esperadas pela imagem <code class="language-plaintext highlighter-rouge">postgres:10-alpine</code>, conforme já explicado. Em <code class="language-plaintext highlighter-rouge">options</code> podemos usar um recurso para aguardar até o postgres estar pronto. Precisamos também mapear a porta do container de serviço para o host porque, por padrão, o container de serviço não expõe a porta - nada diferente do esperado.</p><h2 id="requisitos-para-a-máquina-runner"><span class="mr-2">Requisitos para a máquina runner</span><a href="#requisitos-para-a-máquina-runner" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Um último e importante ajuste é o de garantir que a máquina runner tenha o que é preciso para usar o PostgreSQL. Precisei instalar as dependências necessárias para o pacote <code class="language-plaintext highlighter-rouge">psycopg2</code>. Além disso, no CI anterior não tinha a etapa que executava as migrações, então adicionei. Tem-se então as etapas <code class="language-plaintext highlighter-rouge">Install postgres prerequisites</code> e <code class="language-plaintext highlighter-rouge">Run migrations</code>.</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c1"># em jobs.build</span>
  <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Python ${{ matrix.python-version }}</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-python@v2</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">python-version</span><span class="pi">:</span> <span class="s">${{ matrix.python-version }}</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install postgres prerequisites</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">sudo apt-get install libpq-dev</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install Dependencies</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">python -m pip install --upgrade pip</span>
        <span class="s">pip install -r requirements.txt</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run migrations</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">python app/manage.py wait_for_db &amp;&amp; python app/manage.py migrate</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run Tests</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">flake8 --config app/.flake8 &amp;&amp; python app/manage.py test app/</span>
</pre></table></code></div></div><p>O resultado (após, claro, um frutífero processo de falha → mais uma lida na documentação → ajuste → nova tentativa).</p><p><img data-src="/assets/img/github-actions-django-ci-with-postgres.png" alt="Logs de um CI com o PostgreSQL como container de serviço" width="500" data-proofer-ignore></p><p>É isso.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/devops/'>DevOps</a>, <a href='/categories/github-actions/'>Github Actions</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/github-actions/" class="post-tag no-text-decoration" >github actions</a> <a href="/tags/devops/" class="post-tag no-text-decoration" >devops</a> <a href="/tags/ci/" class="post-tag no-text-decoration" >ci</a> <a href="/tags/integra%C3%A7%C3%A3o-cont%C3%ADnua/" class="post-tag no-text-decoration" >integração contínua</a> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/django/" class="post-tag no-text-decoration" >django</a> <a href="/tags/postresql/" class="post-tag no-text-decoration" >postresql</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esta postagem está licenciada sob <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> pelo autor.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartilhar</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=CI+com+Github+Actions+em+projeto+python+com+Django+e+PostgreSQL+-+Paulo+Freitas&url=https%3A%2F%2Fpaulovitorweb.github.io%2Fposts%2FCI-com-Github-Actions-em-projeto-python-com-Django-e-PostgreSQL%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=CI+com+Github+Actions+em+projeto+python+com+Django+e+PostgreSQL+-+Paulo+Freitas&u=https%3A%2F%2Fpaulovitorweb.github.io%2Fposts%2FCI-com-Github-Actions-em-projeto-python-com-Django-e-PostgreSQL%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fpaulovitorweb.github.io%2Fposts%2FCI-com-Github-Actions-em-projeto-python-com-Django-e-PostgreSQL%2F&text=CI+com+Github+Actions+em+projeto+python+com+Django+e+PostgreSQL+-+Paulo+Freitas" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fpaulovitorweb.github.io%2Fposts%2FCI-com-Github-Actions-em-projeto-python-com-Django-e-PostgreSQL%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copie o link" data-title-succeed="Link copiado com sucesso!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Atualizados recentemente</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/E-se-for-preciso-fazer-um-lookup-com-from-condicional-no-MongoDB/">E se for preciso fazer um lookup com ‘from’ condicional no MongoDB?</a><li><a href="/posts/Como-gerar-mapa-de-fluxos-automaticamente-no-QGIS/">Como gerar mapa de fluxos automaticamente no QGIS</a><li><a href="/posts/SQL-espacial-e-otimizacao-ligando-pontos-a-linhas-pela-proximidade/">SQL espacial e otimização: ligando pontos a linhas pela proximidade</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/geotecnologias/">geotecnologias</a> <a class="post-tag" href="/tags/banco-de-dados/">banco de dados</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/django/">django</a> <a class="post-tag" href="/tags/mongo/">mongo</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/nosql/">nosql</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/qgis/">qgis</a> <a class="post-tag" href="/tags/sig/">sig</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Conteúdo</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Leia também</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Modelagem-e-mapeamento-automaticos-de-um-shapefile-no-GeoDjango/"><div class="card-body"> <em class="small" data-ts="1593831600" data-df="YYYY-MM-DD" > 2020-07-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Modelagem e mapeamento automáticos de um shapefile no GeoDjango</h3><div class="text-muted small"><p> Um recurso muito útil e que pode economizar tempo e trabalho quando você está fazendo a modelagem de dados geográficos no GeoDjango é automatizar a escrita do modelo e do dicionário de mapeamento. ...</p></div></div></a></div><div class="card"> <a href="/posts/7-conselhos-para-o-desenvolvimento-de-solucoes-com-MongoDB/"><div class="card-body"> <em class="small" data-ts="1662260400" data-df="YYYY-MM-DD" > 2022-09-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>7 conselhos para o desenvolvimento de soluções com MongoDB</h3><div class="text-muted small"><p> Depois de passar alguns anos usando apenas bancos de dados relacionais e há mais de um ano trabalhando com MongoDB, passei de alguém que torcia o nariz quando o assunto era bancos de dados não rela...</p></div></div></a></div><div class="card"> <a href="/posts/Importando-GeoJSON-via-url-no-QGIS/"><div class="card-body"> <em class="small" data-ts="1648090800" data-df="YYYY-MM-DD" > 2022-03-24 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Importando GeoJSON via url no QGIS</h3><div class="text-muted small"><p> O GeoJSON é um formato de intercâmbio de dados geoespaciais baseado no formato JSON – JavaScript Object Notation. É um recurso muito interessante para quem trabalha com dados espaciais, principalme...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/SQL-espacial-e-otimizacao-ligando-pontos-a-linhas-pela-proximidade/" class="btn btn-outline-primary" prompt="Anterior"><p>SQL espacial e otimização: ligando pontos a linhas pela proximidade</p></a> <a href="/posts/E-se-for-preciso-fazer-um-lookup-com-from-condicional-no-MongoDB/" class="btn btn-outline-primary" prompt="Próximo"><p>E se for preciso fazer um lookup com ‘from’ condicional no MongoDB?</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/paulovitorweb">Paulo Freitas</a>. <span data-toggle="tooltip" data-placement="top" title="Exceto onde indicado de outra forma, as postagens do blog neste site são licenciadas sob a Creative Commons Attribution 4.0 International (CC BY 4.0) License pelo autor.">Alguns direitos reservados.</span></p></div><div class="footer-right"><p class="mb-0"> Feito com <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> usando o tema <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> .</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/geotecnologias/">geotecnologias</a> <a class="post-tag" href="/tags/banco-de-dados/">banco de dados</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/django/">django</a> <a class="post-tag" href="/tags/mongo/">mongo</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/nosql/">nosql</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/qgis/">qgis</a> <a class="post-tag" href="/tags/sig/">sig</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3"></p><button type="button" class="btn btn-primary" aria-label="Update"> </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! Nenhum resultado encontrado.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/pt.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
