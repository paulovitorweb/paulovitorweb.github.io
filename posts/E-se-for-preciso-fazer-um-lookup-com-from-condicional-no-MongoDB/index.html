<!DOCTYPE html><html lang="pt-BR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="E se for preciso fazer um lookup com ‘from’ condicional no MongoDB?" /><meta property="og:locale" content="pt_BR" /><meta name="description" content="Essa semana precisei construir uma pipeline de agregação no MongoDB com um objetivo pouco usual: precisava de um estágio de lookup onde o parâmetro from fosse condicional, do tipo: se o valor do campo X for A, pesquise em uma dada collection, se for B, pesquise em outra." /><meta property="og:description" content="Essa semana precisei construir uma pipeline de agregação no MongoDB com um objetivo pouco usual: precisava de um estágio de lookup onde o parâmetro from fosse condicional, do tipo: se o valor do campo X for A, pesquise em uma dada collection, se for B, pesquise em outra." /><link rel="canonical" href="https://paulovitorweb.github.io/posts/E-se-for-preciso-fazer-um-lookup-com-from-condicional-no-MongoDB/" /><meta property="og:url" content="https://paulovitorweb.github.io/posts/E-se-for-preciso-fazer-um-lookup-com-from-condicional-no-MongoDB/" /><meta property="og:site_name" content="Paulo Freitas" /><meta property="og:image" content="https://paulovitorweb.github.io/assets/img/mongodb-lookup-from-two-collections-with-same-field.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-19T00:00:00-03:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://paulovitorweb.github.io/assets/img/mongodb-lookup-from-two-collections-with-same-field.png" /><meta property="twitter:title" content="E se for preciso fazer um lookup com ‘from’ condicional no MongoDB?" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-03-19T15:09:22-03:00","datePublished":"2022-03-19T00:00:00-03:00","description":"Essa semana precisei construir uma pipeline de agregação no MongoDB com um objetivo pouco usual: precisava de um estágio de lookup onde o parâmetro from fosse condicional, do tipo: se o valor do campo X for A, pesquise em uma dada collection, se for B, pesquise em outra.","headline":"E se for preciso fazer um lookup com ‘from’ condicional no MongoDB?","image":"https://paulovitorweb.github.io/assets/img/mongodb-lookup-from-two-collections-with-same-field.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://paulovitorweb.github.io/posts/E-se-for-preciso-fazer-um-lookup-com-from-condicional-no-MongoDB/"},"url":"https://paulovitorweb.github.io/posts/E-se-for-preciso-fazer-um-lookup-com-from-condicional-no-MongoDB/"}</script><title>E se for preciso fazer um lookup com ‘from’ condicional no MongoDB? | Paulo Freitas</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Paulo Freitas"><meta name="application-name" content="Paulo Freitas"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/34652880?v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Paulo Freitas</a></div><div class="site-subtitle font-italic">Python developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIAS</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARQUIVOS</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>PROJETOS</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>SOBRE</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/paulovitorweb" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/paulo-vitor/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['paulogeo5','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>E se for preciso fazer um lookup com ‘from’ condicional no MongoDB?</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Buscar..."> </span> <span id="search-cancel" >Cancelar</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>E se for preciso fazer um lookup com ‘from’ condicional no MongoDB?</h1><div class="post-meta text-muted"> <span> Postado em <em class="" data-ts="1647658800" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-03-19 </em> </span> <span> Atualizado <em class="" data-ts="1647713362" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-03-19 </em> </span><div class="d-flex justify-content-between"> <span> Por <em> <a href="https://github.com/paulovitorweb">Paulo Freitas</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="839 palavras"> <em>4 min</em> de leitura</span></div></div></div><div class="post-content"><p>Essa semana precisei construir uma pipeline de agregação no MongoDB com um objetivo pouco usual: precisava de um estágio de <code class="language-plaintext highlighter-rouge">lookup</code> onde o parâmetro <code class="language-plaintext highlighter-rouge">from</code> fosse condicional, do tipo: se o valor do campo X for A, pesquise em uma dada collection, se for B, pesquise em outra.</p><p>Pense num cenário onde um dado campo do documento armazena um ObjectId que pode ser uma referência a documentos de duas ou mais collections, como uma chave de entidade. Se for preciso buscar o documento dela, como fazer isso numa mesma pipeline e sem perder performance?</p><p><img data-src="/assets/img/mongodb-lookup-from-two-collections-with-same-field.png" alt="Diagrama UML mostrando relação one-to-many em que um campo da entidade poderia conter relação com uma ou outra entidade" data-proofer-ignore> <em>Uma relação one-to-many em que um campo da entidade poderia conter relação com uma ou outra entidade</em></p><p>Pensando em um banco relacional, provavelmente a melhor opção seria fazer duas seleções separadas, em que cada uma filtraria pelo valor do campo X correspondente e faria o join com a tabela correta, e depois uni-las com <code class="language-plaintext highlighter-rouge">UNION</code>. Mas, como seria o modo NoSQL de conseguir esse tipo de informação?</p><p>Bem, o desafio foi esse.</p><p>No começo pensei em coisas como fazer um from condicional:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="dl">'</span><span class="s1">from</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
  <span class="dl">'</span><span class="s1">$cond</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
    <span class="dl">'</span><span class="s1">if</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">'</span><span class="s1">$eq</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$field</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">A</span><span class="dl">'</span><span class="p">]</span>
    <span class="p">},</span> 
    <span class="dl">'</span><span class="s1">then</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">&lt;uma collection&gt;</span><span class="dl">'</span><span class="p">,</span> 
    <span class="dl">'</span><span class="s1">else</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">&lt;outra collection&gt;</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Claro que deu errado, o parse do mongo avaliou como objeto em vez de avaliar a expressão e acusou um erro de tipo, pois esperava receber uma string. E faz sentido.</p><p>Então voltei a pensar em como resolveria isso usando SQL - dois selects e uma união - e, trazendo o conceito para o paradigma não relacional, cheguei à pipeline abaixo. É um exemplo fictício. Primeiro, algumas considerações:</p><ul><li>Estou usando a versão 4.4 do MongoDB, que ainda não suporta a sintaxe concisa para subconsultas no lookup;<li>No exemplo, o campo <code class="language-plaintext highlighter-rouge">field_with_id</code> contém o ObjectId que preciso buscar em duas collections diferentes - <code class="language-plaintext highlighter-rouge">foo</code> e <code class="language-plaintext highlighter-rouge">bar</code>;<li>O campo <code class="language-plaintext highlighter-rouge">category</code> contém um dado categórico que me ajuda a descobrir em qual collection vou encontrar o id em <code class="language-plaintext highlighter-rouge">field_with_id</code>;<li>Os campos <code class="language-plaintext highlighter-rouge">name</code> e <code class="language-plaintext highlighter-rouge">data</code> são aqueles que eu quero no objeto buscado.</ul><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copiado!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
</pre><td class="rouge-code"><pre><span class="p">[</span>
    <span class="p">{</span>
        <span class="dl">'</span><span class="s1">$lookup</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">'</span><span class="s1">from</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">foo</span><span class="dl">'</span><span class="p">,</span>
            <span class="dl">'</span><span class="s1">let</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">'</span><span class="s1">idToLookup</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">$field_with_id</span><span class="dl">'</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="dl">'</span><span class="s1">pipeline</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="dl">'</span><span class="s1">$match</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="dl">'</span><span class="s1">$expr</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                            <span class="dl">'</span><span class="s1">$eq</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$_id</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">$$idToLookup</span><span class="dl">'</span><span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="dl">'</span><span class="s1">$project</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
                        <span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">:</span> <span class="mi">1</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="dl">'</span><span class="s1">as</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">foo_obj</span><span class="dl">'</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="dl">'</span><span class="s1">$lookup</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">'</span><span class="s1">from</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span><span class="p">,</span>
            <span class="dl">'</span><span class="s1">let</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">'</span><span class="s1">idToLookup</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">$field_with_id</span><span class="dl">'</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="dl">'</span><span class="s1">pipeline</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="dl">'</span><span class="s1">$match</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="dl">'</span><span class="s1">$expr</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                            <span class="dl">'</span><span class="s1">$eq</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$_id</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">$$idToLookup</span><span class="dl">'</span><span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="dl">'</span><span class="s1">$project</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
                        <span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">:</span> <span class="mi">1</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="dl">'</span><span class="s1">as</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar_obj</span><span class="dl">'</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="dl">'</span><span class="s1">$addFields</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">'</span><span class="s1">foo_obj</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">'</span><span class="s1">$arrayElemAt</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$foo_obj</span><span class="dl">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="p">},</span>
            <span class="dl">'</span><span class="s1">bar_obj</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">'</span><span class="s1">$arrayElemAt</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">$bar_obj</span><span class="dl">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="dl">'</span><span class="s1">$project</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">'</span><span class="s1">fielda</span><span class="dl">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="dl">'</span><span class="s1">fieldb</span><span class="dl">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
            <span class="dl">'</span><span class="s1">fieldc</span><span class="dl">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="dl">'</span><span class="s1">searched_obj</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="dl">'</span><span class="s1">$switch</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                    <span class="dl">'</span><span class="s1">branches</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="dl">'</span><span class="s1">case</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                                <span class="dl">'</span><span class="s1">$eq</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span>
                                    <span class="dl">'</span><span class="s1">$category</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">A</span><span class="dl">'</span>
                                <span class="p">]</span>
                            <span class="p">},</span> 
                            <span class="dl">'</span><span class="s1">then</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">$foo_obj</span><span class="dl">'</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="dl">'</span><span class="s1">case</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                                <span class="dl">'</span><span class="s1">$eq</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span>
                                    <span class="dl">'</span><span class="s1">$category</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">B</span><span class="dl">'</span>
                                <span class="p">]</span>
                            <span class="p">},</span> 
                            <span class="dl">'</span><span class="s1">then</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">$bar_obj</span><span class="dl">'</span>
                        <span class="p">}</span>
                    <span class="p">],</span> 
                    <span class="dl">'</span><span class="s1">default</span><span class="dl">'</span><span class="p">:</span> <span class="kc">null</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></table></code></div></div><p>Parece grande, mas na prática são apenas 3 estágios essenciais. A ideia foi executar dois lookups, um para cada collection, e depois usar o <code class="language-plaintext highlighter-rouge">switch</code> pra escolher qual objeto seria considerado de acordo com o campo <code class="language-plaintext highlighter-rouge">category</code>. O estágio <code class="language-plaintext highlighter-rouge">addFields</code> aqui serve apenas para pegar do array o primeiro - e neste caso único - objeto retornado pela pesquisa. Estou usando a sintaxe com subconsulta no lookup para já trazer apenas os campos de interesse <code class="language-plaintext highlighter-rouge">name</code> e <code class="language-plaintext highlighter-rouge">data</code> e evitar desperdício de memória (um benefício talvez quase nulo a depender da situação, mas é uma boa prática).</p><p>No começo, cheirava a gambiarra, mas depois vi que performou muito bem, tendo um aumento de cerca de apenas 10% no tempo de processamento total (não apenas do banco de dados, considerando latência etc.). Logo percebi que era justamente o modo não relacional de fazer esse tipo de consulta.</p><p>Claro que uma modelagem dos dados pensada para essa finalidade desde a concepção poderia considerar a incorporação dos campos de interesse em cada documento, o que evitaria a necessidade de junções. Mas não foi esse o caso.</p><p>Uma ressalva importante aqui é que essa consulta funcionou muito bem para o problema que tinha, que envolvia num estágio anterior um belo filtro que fazia com que a quantidade de documentos a essa altura do pipeline fosse já drasticamente reduzida. A performance desse tipo de consulta vai variar para cada aplicação e também deve considerar a existência de índices. Se você for buscar algo diferente da chave primária ou fazer consultas com correspondências compostas, considere ajustar índices para garantir uma boa performance.</p><p>É isso.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/banco-de-dados/'>Banco de dados</a>, <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/banco-de-dados/" class="post-tag no-text-decoration" >banco de dados</a> <a href="/tags/nosql/" class="post-tag no-text-decoration" >nosql</a> <a href="/tags/database/" class="post-tag no-text-decoration" >database</a> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/mongo/" class="post-tag no-text-decoration" >mongo</a> <a href="/tags/lookup/" class="post-tag no-text-decoration" >lookup</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> Esta postagem está licenciada sob <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> pelo autor.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Compartilhar</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=E+se+for+preciso+fazer+um+lookup+com+%E2%80%98from%E2%80%99+condicional+no+MongoDB%3F+-+Paulo+Freitas&url=https%3A%2F%2Fpaulovitorweb.github.io%2Fposts%2FE-se-for-preciso-fazer-um-lookup-com-from-condicional-no-MongoDB%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=E+se+for+preciso+fazer+um+lookup+com+%E2%80%98from%E2%80%99+condicional+no+MongoDB%3F+-+Paulo+Freitas&u=https%3A%2F%2Fpaulovitorweb.github.io%2Fposts%2FE-se-for-preciso-fazer-um-lookup-com-from-condicional-no-MongoDB%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fpaulovitorweb.github.io%2Fposts%2FE-se-for-preciso-fazer-um-lookup-com-from-condicional-no-MongoDB%2F&text=E+se+for+preciso+fazer+um+lookup+com+%E2%80%98from%E2%80%99+condicional+no+MongoDB%3F+-+Paulo+Freitas" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fpaulovitorweb.github.io%2Fposts%2FE-se-for-preciso-fazer-um-lookup-com-from-condicional-no-MongoDB%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copie o link" data-title-succeed="Link copiado com sucesso!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Atualizados recentemente</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/E-se-for-preciso-fazer-um-lookup-com-from-condicional-no-MongoDB/">E se for preciso fazer um lookup com ‘from’ condicional no MongoDB?</a><li><a href="/posts/Como-gerar-mapa-de-fluxos-automaticamente-no-QGIS/">Como gerar mapa de fluxos automaticamente no QGIS</a><li><a href="/posts/SQL-espacial-e-otimizacao-ligando-pontos-a-linhas-pela-proximidade/">SQL espacial e otimização: ligando pontos a linhas pela proximidade</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/geotecnologias/">geotecnologias</a> <a class="post-tag" href="/tags/banco-de-dados/">banco de dados</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/django/">django</a> <a class="post-tag" href="/tags/mongo/">mongo</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/nosql/">nosql</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/qgis/">qgis</a> <a class="post-tag" href="/tags/sig/">sig</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Leia também</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/7-conselhos-para-o-desenvolvimento-de-solucoes-com-MongoDB/"><div class="card-body"> <em class="small" data-ts="1662260400" data-df="YYYY-MM-DD" > 2022-09-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>7 conselhos para o desenvolvimento de soluções com MongoDB</h3><div class="text-muted small"><p> Depois de passar alguns anos usando apenas bancos de dados relacionais e há mais de um ano trabalhando com MongoDB, passei de alguém que torcia o nariz quando o assunto era bancos de dados não rela...</p></div></div></a></div><div class="card"> <a href="/posts/SQL-espacial-e-otimizacao-ligando-pontos-a-linhas-pela-proximidade/"><div class="card-body"> <em class="small" data-ts="1644807600" data-df="YYYY-MM-DD" > 2022-02-14 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SQL espacial e otimização: ligando pontos a linhas pela proximidade</h3><div class="text-muted small"><p> Um tempo atrás precisei encontrar uma forma de relacionar um grande volume de geometrias pela localização no PostGIS. Tinha uma base com centenas de milhares de pares de coordenadas de GPS de veícu...</p></div></div></a></div><div class="card"> <a href="/posts/Importando-GeoJSON-via-url-no-QGIS/"><div class="card-body"> <em class="small" data-ts="1648090800" data-df="YYYY-MM-DD" > 2022-03-24 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Importando GeoJSON via url no QGIS</h3><div class="text-muted small"><p> O GeoJSON é um formato de intercâmbio de dados geoespaciais baseado no formato JSON – JavaScript Object Notation. É um recurso muito interessante para quem trabalha com dados espaciais, principalme...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/CI-com-Github-Actions-em-projeto-python-com-Django-e-PostgreSQL/" class="btn btn-outline-primary" prompt="Anterior"><p>CI com Github Actions em projeto python com Django e PostgreSQL</p></a> <a href="/posts/Importando-GeoJSON-via-url-no-QGIS/" class="btn btn-outline-primary" prompt="Próximo"><p>Importando GeoJSON via url no QGIS</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/paulovitorweb">Paulo Freitas</a>. <span data-toggle="tooltip" data-placement="top" title="Exceto onde indicado de outra forma, as postagens do blog neste site são licenciadas sob a Creative Commons Attribution 4.0 International (CC BY 4.0) License pelo autor.">Alguns direitos reservados.</span></p></div><div class="footer-right"><p class="mb-0"> Feito com <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> usando o tema <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> .</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/geotecnologias/">geotecnologias</a> <a class="post-tag" href="/tags/banco-de-dados/">banco de dados</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/django/">django</a> <a class="post-tag" href="/tags/mongo/">mongo</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/nosql/">nosql</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/qgis/">qgis</a> <a class="post-tag" href="/tags/sig/">sig</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3"></p><button type="button" class="btn btn-primary" aria-label="Update"> </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! Nenhum resultado encontrado.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/pt.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
